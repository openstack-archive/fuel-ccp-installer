---
- name: Ensure required ansible version
  assert:
    that: ansible_version.major == 2 and ansible_version.minor >= 1
  run_once: true

- name: "Wait for all hosts"
  local_action: wait_for host={{ ip | default(ansible_hostname) }} port=22 state=started timeout=30
  become: false

- name: Gather facts
  setup:

- name: Gather local SSH pubkeys
  local_action: shell ssh-add -L
  become: false
  register: ssh_pubkeys

- name: Add SSH pubkey to authorized_keys
  authorized_key:
    user: "{{ ansible_ssh_user }}"
    key: "{{ item }}"
    state: present
  with_items: ssh_pubkeys.stdout_lines

- name: Create temp cert files
  local_action: copy content={{ item.pem }} dest=/tmp/{{ item.name }}
  become: true
  run_once: true
  with_items: "{{ certificates }}"

- name: Determine selfsigned certs
  local_action: shell [ "$(openssl x509 -noout -subject -in /tmp/{{ item.name }}|awk '{print $2}')" = "$(openssl x509 -noout -issuer -in /tmp/{{ item.name }}|awk '{print $2}')" ]
  become: false
  run_once: true
  register: certscheck
  ignore_errors: yes
  with_items: "{{ certificates }}"

- name: Get self signed certs
  local_action: slurp src=/tmp/{{ item.item }}
  become: false
  run_once: true
  register: self_signed_certs
  when: item.rc == 0
  with_items: "{{ certscheck.results }}"

- name: Remove temp cert files
  local_action: file dest=/tmp/{{ item.name }} state=absent
  become: true
  run_once: true
  with_items: "{{ certificates }}"

- name: Mark self signed certs as trusted for nodes
  copy:
    content: "{{ item.content|b64decode }}"
    dest: "/usr/local/share/ca-certificates/{{ item.source|basename }}"
    force: yes
    mode: "0600"
    owner: "root"
  notify: Preinstall | update certs
  become: true
  with_items: "{{ self_signed_certs.results }}"

- name: Set correct /etc/hosts entry
  register: updated_etc_hosts
  lineinfile:
    dest: /etc/hosts
    regexp: "127.0.1.1.*"
    line: "{{ ip }}\t{{ inventory_hostname }}"
    state: present

- name: Update hostname via hostnamectl
  command: hostnamectl set-hostname {{ inventory_hostname }}
  when: updated_etc_hosts.changed

- name: Ensure dnsutils is installed
  apt:
    name: dnsutils
    state: latest
  when: ansible_os_family == "Debian"

# FIXME(mattymo): Opts are set too late (https://github.com/kubespray/kargo/issues/487)
- name: Set Docker options early
  template:
    src: docker.j2
    dest: /etc/default/docker
    owner: root
    group: root
    mode: 0644
